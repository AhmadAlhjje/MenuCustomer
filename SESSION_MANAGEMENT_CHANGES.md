# تعديلات إدارة الجلسات

## ملخص التغييرات

تم تحديث المشروع لإضافة ميزات متقدمة لإدارة جلسات المستخدمين مع التحقق من انتهاء الصلاحية بعد 10 ساعات.

## التعديلات الرئيسية

### 1. **src/utils/storage.ts** - إضافة دوال إدارة الجلسات مع Timestamps

تم إضافة واجهة `SessionData` ودوال جديدة:

```typescript
// تخزين sessionId مع createdAt
storage.setSession(sessionId: number)

// استرجاع بيانات الجلسة
storage.getSession(): SessionData | null

// حذف بيانات الجلسة
storage.clearSession()

// التحقق من انتهاء الجلسة (>10 ساعات)
storage.isSessionExpired(): boolean

// الحصول على عمر الجلسة بالساعات
storage.getSessionAgeHours(): number
```

**الهيكل المخزن:**
```json
{
  "sessionId": 4,
  "createdAt": "2025-11-26T10:37:34.000Z"
}
```

---

### 2. **src/store/slices/sessionSlice.ts** - تحديث Redux Slice

تم تحديث الـ reducer ليستخدم الدوال الجديدة:

- **setSession**: يخزن الآن `sessionId` و `createdAt` معاً
- **clearSession**: يمسح كل بيانات الجلسة من localStorage
- **loadSessionFromStorage**: يفحص انتهاء الجلسة عند التحميل، وإذا انتهت (>10 ساعات) يمسحها تلقائياً

```typescript
// عند التحميل من localStorage، إذا انتهت الجلسة يتم مسحها تلقائياً
dispatch(loadSessionFromStorage());
```

---

### 3. **src/app/qr/[code]/page.tsx** - فحص انتهاء الجلسة عند تصوير QR جديد

تم إضافة فحص قبل إنشاء جلسة جديدة:

```typescript
const existingSessionData = storage.getSession();
if (existingSessionData) {
  const sessionAgeHours = storage.getSessionAgeHours();

  if (sessionAgeHours > 10) {
    // مسح الجلسة القديمة
    storage.clearSession();
  }
}
```

**السلوك:**
1. عند تصوير QR، يتم التحقق من وجود جلسة قديمة
2. إذا كانت الجلسة أقدم من 10 ساعات، يتم مسحها تلقائياً
3. يتم حفظ الجلسة الجديدة مع timestamp جديد

---

### 4. **src/app/menu/page.tsx** - إضافة زر "إنهاء الجلسة"

تم إضافة زر جديد في رأس الصفحة بجانب زر الطلبات:

```typescript
const handleEndSession = () => {
  dispatch(clearSession());
  storage.clearSession();
  success(t('session.sessionEnded') || 'تم إنهاء الجلسة بنجاح');
  router.push('/');
};
```

**الواجهة:**
- زر أحمر مع أيقونة خروج
- نص: "إنهاء" أو "إنهاء الجلسة" حسب حجم الشاشة
- يوجد بجانب زر "الطلب الحالي"
- عند النقر عليه:
  1. يمسح الجلسة من Redux و localStorage
  2. يعرض رسالة نجاح
  3. يعيد توجيه المستخدم إلى الصفحة الرئيسية

---

### 5. **src/hooks/useSessionGuard.ts** - فحص دوري لانتهاء الجلسة

تم إضافة فحص دوري كل 5 دقائق:

```typescript
// يفحص كل 5 دقائق إذا انتهت الجلسة
const interval = setInterval(checkSessionExpiration, 5 * 60 * 1000);
```

**السلوك:**
1. عند تحميل صفحة تحتاج sessionId، يتم تفعيل الفحص الدوري
2. كل 5 دقائق يتم التحقق من انتهاء الجلسة
3. إذا انتهت الجلسة (>10 ساعات)، يتم:
   - مسح الجلسة من Redux و localStorage
   - إعادة توجيه المستخدم إلى الصفحة الرئيسية

---

## سير العمل

### سيناريو 1: جلسة عادية (أقل من 10 ساعات)
```
1. المستخدم يصور QR
2. يتم إنشاء جلسة جديدة
3. يتم تخزين: { sessionId, createdAt }
4. يدخل المستخدم الى قائمة الطعام
5. يضيف الطلبات ويرسلها
6. يضغط "إنهاء الجلسة" (أو ينتظر 10 ساعات)
```

### سيناريو 2: جلسة منتهية الصلاحية (أكثر من 10 ساعات)
```
1. المستخدم قد يكون في الصفحة لمدة +10 ساعات
2. الفحص الدوري (كل 5 دقائق) يكتشف الانتهاء
3. الجلسة تُمسح تلقائياً
4. المستخدم يعاد توجيهه إلى الصفحة الرئيسية
```

### سيناريو 3: إعادة تحميل الصفحة مع جلسة منتهية
```
1. المستخدم يرجع للصفحة بعد أكثر من 10 ساعات
2. `loadSessionFromStorage()` يفحص الصلاحية
3. إذا انتهت، يتم مسحها تلقائياً
4. المستخدم يبدأ من جديد
```

### سيناريو 4: تصوير QR مع وجود جلسة قديمة
```
1. المستخدم قد يكون لديه جلسة قديمة في localStorage
2. عند محاولة تصوير QR جديد
3. يتم التحقق من عمر الجلسة القديمة
4. إذا كانت >10 ساعات، يتم مسحها
5. يتم إنشاء جلسة جديدة بـ timestamp جديد
```

---

## الثوابت

- **مدة الجلسة:** 10 ساعات
- **فترة الفحص الدوري:** 5 دقائق
- **مفاتيح localStorage:**
  - `sessionData`: يحتوي على `{ sessionId, createdAt }`
  - `sessionId`: الـ ID القديم (للتوافق)

---

## الترجمة (i18n)

يتم استخدام المفاتيح التالية (تأكد من إضافتها في ملفات الترجمة):

- `session.endSession` - "إنهاء الجلسة"
- `session.sessionEnded` - "تم إنهاء الجلسة بنجاح"

إذا لم تكن موجودة، سيتم استخدام القيم الافتراضية بالعربية.

---

## الفوائد

✅ **أمان محسّن:** إغلاق تلقائي للجلسات القديمة
✅ **تجربة المستخدم:** زر واضح لإنهاء الجلسة يدوياً
✅ **الحماية من التحايل:** فحص دوري للتحقق من الصلاحية
✅ **لا تعطيل:** يعمل بسلاسة مع الكود الموجود
✅ **توثيق واضح:** رسائل في console لتتبع العمليات

---

## ملاحظات تقنية

- جميع التحقيقات تستخدم `ISO 8601` format للتاريخ
- الحسابات تتم بالمللي ثانية ثم تحويل إلى ساعات
- التخزين يتم في `localStorage` (يعمل فقط في المتصفح)
- `SSR` محمي باستخدام `typeof window !== 'undefined'` checks
